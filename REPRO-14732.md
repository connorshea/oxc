# Reproduction for Issue #14732: Windows Heap Corruption with Worker Threads

## Issue Summary

When importing `oxc-parser` in Node.js worker threads on Windows, the process crashes with a heap corruption error:
- Error code: `-1073740940` (0xC0000374 = `STATUS_HEAP_CORRUPTION`)
- Occurs with 16 concurrent worker threads
- Started between v0.92.0 (working) and v0.95.0 (broken)
- **Windows-specific issue** - does not reproduce on macOS

## Reproduction Files

### Test Files Location
- `napi/parser/test-worker-main.mjs` - Main script that spawns 16 workers
- `napi/parser/test-worker.mjs` - Worker script that imports oxc-parser

### Running the Reproduction

#### On macOS (for validation):
```bash
cd napi/parser
pnpm build-dev
node test-worker-main.mjs
```

Expected result: All 16 workers complete successfully without crashes.

#### On Windows:
```bash
cd napi/parser
pnpm build --features allocator --release
node test-worker-main.mjs
```

Expected result with v0.95.0: Process crashes with heap corruption error.

## Testing Different Versions

To test specific versions during bisect:

```bash
# Checkout a specific commit
git checkout <commit-hash>

# Build and test
cd napi/parser
pnpm build-dev --features allocator --release
node test-worker-main.mjs
```

## Bisect Process

### Option 1: Using GitHub Actions (Recommended)

GitHub Actions can run the tests on Windows automatically:

1. **Test a specific commit:**
   - Go to: Actions → "Debug Issue 14732 - Windows Worker Thread Crash"
   - Click "Run workflow"
   - Enter the commit SHA to test (or leave empty for HEAD)
   - Click "Run workflow"
   - Check if the job succeeds (GOOD) or fails (BAD)

2. **Automated bisect range:**
   - Go to: Actions → "Bisect Issue 14732"
   - Click "Run workflow"
   - Enter "range" to test commits between v0.92.0 and v0.95.0
   - Or enter specific commits separated by commas
   - Results will show which commits are GOOD/BAD

### Option 2: Manual Bisect on Windows

To find the breaking commit manually on a Windows machine:

```bash
git bisect start
git bisect bad crates_v0.95.0    # 454ee94ff
git bisect good crates_v0.92.0   # 1b3f43746

# For each commit, run:
./bisect-test.sh
# Then mark as good/bad:
git bisect good   # if test passes
git bisect bad    # if test fails
```

## Root Cause Investigation

### Key Findings

1. **Global Allocator Present**: The NAPI parser uses `mimalloc-safe` as a global allocator:
   ```rust
   #[cfg(all(
       feature = "allocator",
       not(any(target_arch = "arm", target_os = "freebsd", target_family = "wasm"))
   ))]
   #[global_allocator]
   static ALLOC: mimalloc_safe::MiMalloc = mimalloc_safe::MiMalloc;
   ```
   Location: `napi/parser/src/lib.rs:4-9`

2. **Feature Enabled in Production**: The `allocator` feature is enabled when building release binaries:
   ```json
   "build": "pnpm run build-dev --features allocator --release"
   ```
   Location: `napi/parser/package.json`

3. **Same Configuration in Both Versions**: Both v0.92.0 and v0.95.0 have:
   - Same global allocator setup
   - Same `mimalloc-safe` version (0.1.54)
   - Same build configuration

4. **Windows-Specific Behavior**: Global allocators in Rust can have platform-specific issues with threads, particularly on Windows where thread-local storage (TLS) behaves differently.

### Potential Causes

1. **Worker Thread Isolation**: Node.js worker threads create separate V8 isolates but share the same process memory. A global allocator might not be thread-safe across worker boundaries on Windows.

2. **TLS Configuration**: The Windows builds use `local_dynamic_tls` feature for mimalloc on Linux, but Windows may need different configuration.

3. **NAPI Changes**: Changes to how NAPI modules are loaded/initialized between versions could affect how the global allocator is initialized per worker.

### Next Steps for Bisect

Focus on commits between v0.92.0 and v0.95.0 that touch:
- NAPI module initialization
- Global allocator configuration
- Worker thread handling
- mimalloc configuration or upgrades
- Changes to `napi/parser/src/lib.rs`

## macOS Test Results

✅ All tests pass on macOS (5 runs, 16 workers each, 80 workers total)
- No crashes detected
- All workers complete successfully
- Confirms issue is Windows-specific

## Related Commits

Between v0.92.0 (1b3f43746) and v0.95.0 (454ee94ff):
- Global allocator was added in: aa3dff887 (but this is before v0.92.0)
- No significant changes to the global allocator setup in lib.rs
- Need to investigate NAPI runtime changes and module loading changes
